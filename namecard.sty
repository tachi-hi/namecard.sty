%% namecard.sty
%% LaTeX package for creating business cards (名刺)
%%
%% This package creates a 2x5 grid of business cards on A4 paper.
%% Each card is 91mm x 55mm (Japanese standard business card size).
%%
%% Supported engines: LuaLaTeX (recommended), upLaTeX
%% Recommended document class: jlreq
%%
%% Options:
%%   icons - Enable fontawesome5 icons for contact information
%%   frame - Show card boundaries (non-printable, visible on screen only)
%%
%% Reference: http://www.w3-4f5f.ee.uec.ac.jp/nameCard/

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{namecard}

%% ============================================================================
%% Package Options
%% ============================================================================

\newif\if@namecard@icons
\@namecard@iconsfalse

\newif\if@namecard@frame
\@namecard@framefalse

\DeclareOption{icons}{\@namecard@iconstrue}
\DeclareOption{frame}{\@namecard@frametrue}
\ProcessOptions\relax

%% Load ocgx2 for non-printable frame (PDF layer)
\if@namecard@frame
  \RequirePackage{ocgx2}
  \RequirePackage{xcolor}
  \definecolor{namecard@framecolor}{rgb}{1,0,0}  % 赤色
\fi

%% ============================================================================
%% Engine Detection and Icon Setup
%% ============================================================================

\RequirePackage{iftex}

%% Load fontawesome5 if icons option is enabled (LuaLaTeX only)
\if@namecard@icons
  \ifluatex
    \RequirePackage{fontawesome5}
    %% Define icon commands (simple style like ☎)
    \newcommand{\namecardPhoneIcon}{\faPhone~}              % 電話
    \newcommand{\namecardEmailIcon}{\faEnvelope[regular]~}  % メール
    \newcommand{\namecardAddressIcon}{}                     % 住所はアイコンなし
    \newcommand{\namecardMobileIcon}{\faMobileAlt~}         % 携帯電話
    \newcommand{\namecardFaxIcon}{\faFax~}                  % FAX
    \newcommand{\namecardBuildingIcon}{\faBuilding[regular]~} % 建物（白抜き）
    \newcommand{\namecardWebIcon}{\faGlobe~}                % ウェブ
  \else
    \PackageWarning{namecard}{icons option requires LuaLaTeX. Icons will be disabled.}
    %% Define empty icon commands for compatibility
    \newcommand{\namecardPhoneIcon}{}
    \newcommand{\namecardEmailIcon}{}
    \newcommand{\namecardAddressIcon}{}
    \newcommand{\namecardBuildingIcon}{}
    \newcommand{\namecardMobileIcon}{}
    \newcommand{\namecardFaxIcon}{}
    \newcommand{\namecardWebIcon}{}
  \fi
\else
  %% Define empty icon commands when icons option is not used
  \newcommand{\namecardPhoneIcon}{}
  \newcommand{\namecardEmailIcon}{}
  \newcommand{\namecardAddressIcon}{}
  \newcommand{\namecardBuildingIcon}{}
  \newcommand{\namecardMobileIcon}{}
  \newcommand{\namecardFaxIcon}{}
  \newcommand{\namecardWebIcon}{}
\fi

%% ============================================================================
%% Page Layout
%% ============================================================================
%% Configure page dimensions for A4 paper with 2x5 card grid
%% Card size: 91mm x 55mm
%% Page layout: 14mm left/right margin, 11mm top/bottom margin

\setlength{\textwidth}{182truemm}
\setlength{\hoffset}{0in}
\setlength{\voffset}{0in}
\setlength{\headheight}{0in}
\setlength{\headsep}{0in}
\setlength{\oddsidemargin}{14truemm}
\setlength{\textheight}{275truemm}
\setlength{\topmargin}{11truemm}
\advance\oddsidemargin -1in
\advance\topmargin -1in
\setlength{\footskip}{0in}

\parindent=0pt
\pagestyle{empty}

%% ============================================================================
%% Content Setting Commands
%% ============================================================================
%% Commands to set the content of the business card

% Company and department
\newcommand{\setCompany}[1]{\def\getCompany{#1}}
\newcommand{\setDepartment}[1]{\def\getDepartment{#1}}

% Name (Japanese and English)
\newcommand{\setName}[1]{\def\getName{#1}}
\newcommand{\setNameEnglish}[1]{\def\getNameEnglish{#1}}

% Contact information (raw, without icons)
\newcommand{\setAddress}[1]{\def\getAddress@raw{#1}}
\newcommand{\setPhone}[1]{\def\getPhone@raw{#1}}
\newcommand{\setEmail}[1]{\def\getEmail@raw{#1}}

% Title/Position (肩書き)
\newcommand{\setKatagaki}[1]{\def\getKatagaki{#1}}

%% Internal commands that add icons if enabled
\newcommand{\getAddress}{\namecardAddressIcon\getAddress@raw}
\newcommand{\getPhone}{\namecardPhoneIcon\getPhone@raw}
\newcommand{\getEmail}{\namecardEmailIcon\getEmail@raw}

%% ============================================================================
%% Layout Adjustment Commands
%% ============================================================================
%% Commands to fine-tune the card layout

% Left margin within the card (in mm)
\newcommand{\SetLeftMarginOfNameCard}[1]{\def\GetLeftMarginOfNameCard{#1}}

% Content indentation (in mm)
\newcommand{\SetIndentOfNameCard}[1]{\def\GetIndentOfNameCard{#1}}

%% ============================================================================
%% Card Generation
%% ============================================================================
%% Main command to generate a page of business cards

\newcommand{\makeNameCard}{%
  \begin{picture}(182,275)(0,0)
    %% Draw non-printable frame if frame option is enabled
    \if@namecard@frame
      \begin{ocg}[printocg=never]{CardFrame}{cardframe}{1}
        \color{namecard@framecolor}
        % Horizontal dotted lines (6 lines for 5 rows)
        % 点線: 2mm間隔で小さな円を配置
        \multiput(0,0)(0,55){6}{\multiput(0,0)(2,0){92}{\circle*{0.5}}}
        % Vertical dotted lines (3 lines for 2 columns)
        \multiput(0,0)(91,0){3}{\multiput(0,0)(0,2){138}{\circle*{0.5}}}
      \end{ocg}
    \fi
    % Create 5 rows x 2 columns of cards
    \multiput(0,0)(0,55.0){5}{%
      \multiput(0,0)(91,0){2}{%
        % Single card (91mm x 55mm)
        \begin{picture}(91,55)(0,0)
          %% Company and Department (top section)
          \put(\GetLeftMarginOfNameCard,42){%
            \noindent
            \begin{minipage}{91truemm}
              \noindent
              {\bfseries\large \noindent\getCompany}
              \newline
              {\bfseries \noindent \getDepartment}
            \end{minipage}
          }
          %% Name section (middle)
          \put(\GetIndentOfNameCard,25){%
            \noindent
            \begin{minipage}{27truemm}
              \scriptsize \getKatagaki
            \end{minipage}
            \begin{minipage}{60truemm}
              {\bfseries\large{\getName}} \\
              {\footnotesize{\getNameEnglish}}
            \end{minipage}
          }
          %% Contact information (bottom section)
          \put(\GetIndentOfNameCard,9){%
            \begin{minipage}{91truemm}
              \noindent
              \scriptsize
              \getAddress \\
              \getPhone \\
              \getEmail \\
            \end{minipage}
          }
        \end{picture}
      }
    }
  \end{picture}
  \par
}

\endinput
